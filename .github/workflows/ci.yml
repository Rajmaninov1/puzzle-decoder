name: CI

# Trigger workflow on push to main/develop branches and PRs to main
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Run tests across multiple Python versions
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.12", "3.13" ]  # Test on supported Python versions

    steps:
      # Check out the repository code
      - uses: actions/checkout@v4

      # Install uv package manager for fast dependency resolution
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.3
        with:
          version: "latest"

      # Install the specific Python version for this matrix job
      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      # Install all project dependencies including dev dependencies
      - name: Install dependencies
        run: uv sync --all-extras --dev

      # Run pytest with coverage reporting
      - name: Run tests
        run: uv run pytest tests/ -v --cov=src --cov-report=xml

      # Upload coverage results to Codecov (non-blocking)
      - name: Upload coverage
        uses: codecov/codecov-action@v5.5.1
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Code quality and formatting checks
  lint:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository code
      - uses: actions/checkout@v5.0.0

      # Install uv package manager
      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.3

      # Use Python 3.12 for linting (consistent version)
      - name: Set up Python
        run: uv python install 3.12

      # Install dev dependencies for linting tools
      - name: Install dependencies
        run: uv sync --dev

      # Run ruff linting
      - name: Run ruff check
        run: uv run ruff check src/ tests/

      # Run ruff formatting check
      - name: Run ruff format check
        run: uv run ruff format --check src/ tests/

  # Build and test Docker services (only on the main branch)
  docker:
    runs-on: ubuntu-latest
    needs: [ test, lint ]  # Wait for tests and linting to pass
    if: github.ref == 'refs/heads/main'  # Only run on the main branch
    
    steps:
      # Check out the repository code
      - uses: actions/checkout@v5.0.0

      # Build and start services
      - name: Build Docker services
        run: docker compose build

      # Override puzzle-solver to run CLI instead of web server
      - name: Test puzzle solver CLI
        run: docker compose run --rm puzzle-solver python -m puzzle_solver.cli.main
